@model VirtualStore.Models.ViewModel.ProductViewModel
@{
    ViewBag.Title = "Edit Product";
    var priceValue = (Request["price"] ?? (ViewBag.PriceInput as string) ?? Model.price.ToString());
    var currentImg = string.IsNullOrWhiteSpace(Model.imageProd)
        ? "/Content/images/product-default-image.png"
        : Model.imageProd;
}

<div class="page-title">
    <h2>Edit Product</h2>
</div>

<div class="store-card admin-form-card">
    @using (Html.BeginForm("Edit", "Products", new { id = Model.Id }, FormMethod.Post, new { enctype = "multipart/form-data" }))
    {
        @Html.AntiForgeryToken()
        @Html.ValidationSummary(true, "", new { @class = "text-danger" })

        @Html.HiddenFor(m => m.Id)
        @Html.HiddenFor(m => m.imageProd)

        <div class="admin-form-grid">

            <!-- LEFT -->
            <div class="admin-fields">

                <div class="admin-row-2">
                    <div>
                        <label class="admin-label">Product name:</label>
                        @Html.TextBoxFor(m => m.nameProd, new { @class = "admin-input" })
                        @Html.ValidationMessageFor(m => m.nameProd, "", new { @class = "text-danger" })
                    </div>

                    <div>
                        <label class="admin-label">Price (€):</label>
                        <input class="admin-input" type="text" name="price" value="@priceValue" />
                        @Html.ValidationMessage("price", "", new { @class = "text-danger" })
                    </div>
                </div>

                <div class="admin-row-2">
                    <div>
                        <label class="admin-label">Stock quantity:</label>
                        @Html.TextBoxFor(m => m.stockProd, new { @class = "admin-input", type = "number", min = "0", step = "1" })
                        @Html.ValidationMessageFor(m => m.stockProd, "", new { @class = "text-danger" })
                    </div>

                    <div>
                        <label class="admin-label">Category:</label>
                        @Html.DropDownListFor(m => m.Category_Id, Model.Categories, "-- Select Category --", new { @class = "admin-input" })
                        @Html.ValidationMessageFor(m => m.Category_Id, "", new { @class = "text-danger" })
                    </div>
                </div>

                <div class="admin-check">
                    @Html.CheckBoxFor(m => m.isActiveProd)
                    <span style="font-weight:800;">Active</span>
                </div>

                <div class="admin-desc">
                    <label class="admin-label">Product description:</label>
                    @Html.TextAreaFor(m => m.descripProd, 7, 0, new { @class = "admin-input admin-textarea" })
                    @Html.ValidationMessageFor(m => m.descripProd, "", new { @class = "text-danger" })
                </div>

                <div class="admin-actions">
                    <button type="submit" class="btn btn-brand btn-big">Save</button>
                    @Html.ActionLink("Back to List", "Index", null, new { @class = "btn btn-outline btn-big" })
                </div>
            </div>

            <!-- RIGHT -->
            <div class="preview-panel">
                <div class="preview-title">Preview</div>

                <div class="preview-box">
                    <img id="imgPreview" class="preview-img" src="@Url.Content(currentImg)" alt="Preview" />
                </div>

                <div class="preview-sub">
                    <label class="admin-label">Replace image (optional)</label>
                    <input id="imageFile" type="file" name="imageFile" class="admin-input" accept=".png,.jpg,.jpeg,.webp" />
                    @if (ViewBag.ImageError != null)
                    {
                        <div class="text-danger" style="margin-top:6px;">@ViewBag.ImageError</div>
                    }
                </div>
            </div>

        </div>
    }
</div>

@section Scripts {
    <script>
        (function () {
            var input = document.getElementById('imageFile');
            var preview = document.getElementById('imgPreview');
            if (!input || !preview) return;

            input.addEventListener('change', function () {
                var file = this.files && this.files[0];
                if (!file) return;

                var reader = new FileReader();
                reader.onload = function (e) { preview.src = e.target.result; };
                reader.readAsDataURL(file);
            });
        })();
    </script>
}